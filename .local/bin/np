#!/usr/bin/env python3

import shutil
import subprocess
import sys
from pathlib import Path

REPO_URL = "https://github.com/hakan-demirli/code_templates"
CACHE_DIR = Path.home() / ".cache" / "np_templates"
GIT = shutil.which("git") or "git"

"""
np: new project
copy a template project to current dir.
"""


def clone_repo():
    CACHE_DIR.parent.mkdir(parents=True, exist_ok=True)
    subprocess.run([GIT, "clone", "--depth", "1", REPO_URL, str(CACHE_DIR)], check=True)


def pull_repo():
    if CACHE_DIR.exists():
        try:
            subprocess.run([GIT, "-C", str(CACHE_DIR), "pull"], check=True)
            print("Cache updated.")
        except subprocess.CalledProcessError as e:
            print(f"Failed to update cache: {e}")
    else:
        print("Cache not found. Cloning...")
        clone_repo()


def run_fzf_inside_cache_and_copy():
    if not CACHE_DIR.exists():
        print("Cache not found. Run `np pull` first.")
        sys.exit(1)

    try:
        dirs = [d for d in CACHE_DIR.iterdir() if d.is_dir()]
        sorted_dirs = sorted(dirs)
        fzf_input = "\n".join(str(path) for path in sorted_dirs).encode("utf-8")
        fzf_proc = subprocess.run(
            ["fzf"], input=fzf_input, stdout=subprocess.PIPE, check=True
        )
        selected_directory = fzf_proc.stdout.decode().strip()

        if selected_directory:
            selected_path = Path(selected_directory)
            dest = Path.cwd() / selected_path.name
            shutil.copytree(selected_path, dest)
            print(f"Project copied to: {dest}")
        else:
            print("No directory selected.")

    except subprocess.CalledProcessError as e:
        print(f"Operation cancelled or fzf failed: {e}")


if __name__ == "__main__":
    if len(sys.argv) > 1 and sys.argv[1] == "pull":
        pull_repo()
    else:
        run_fzf_inside_cache_and_copy()
