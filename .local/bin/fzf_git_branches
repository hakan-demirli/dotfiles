#!/usr/bin/env bash

function fgb() {
	local -r git_branches_local="git branch --all --color --format=$'%(HEAD) %(color:yellow)%(refname:short)\t%(color:green)%(committerdate:short)\t%(color:blue)%(subject)' | column --table --separator=$'\t'"
	local -r git_branches_remote="git ls-remote --heads origin | awk '{print \$2}' | sed 's/refs\\/heads\\///' | grep -v '^master$' | grep -v '^veridian$' | awk '{print \"remotes/origin/\" \$1}'" # Remove the 'origin/' prefix to avoid duplication
	local -r get_selected_branch='echo {} | sed "s/^[* ]*//" | awk "{print \$1}"'
    local get_branch_name='echo {} | sed "s/^[* ]*//" | awk "{print \$1}" | sed "s|remotes/origin/||g"'
	local -r git_log="git log \$($get_selected_branch) --graph --color --format='%C(white)%h - %C(green)%cs - %C(blue)%s%C(red)%d'"
	local -r git_diff='git diff --color $(git branch --show-current)..$(echo {} | sed "s/^[* ]*//" | awk "{print \$1}")'
	local -r git_show_subshell=$(cat <<-EOF
		[[ \$($get_selected_branch) != '' ]] && sh -c "git show --color \$($get_selected_branch) | less -R"
	EOF
	)
	local -r header=$(cat <<-EOF
	> Ctrl-M to merge with current * branch | ALT-R to rebase with current * branch
	> ENTER to checkout the branch
	> Ctrl+G to open the diff with less
	EOF
	)

	(
		eval "$git_branches_local"
		eval "$git_branches_remote" | while read branch; do
            if ! git show-ref --quiet "refs/heads/${branch##*/}"; then
                printf '%s\n' "$branch";
            fi
        done
	) \
	| fzf \
		--ansi \
		--reverse \
		--no-sort \
		--preview-label '[ Commits ]' \
		--preview "$git_log" \
		--header-first \
		--header="$header" \
		--bind="enter:execute(git fetch origin \$($get_branch_name):\$($get_branch_name) && git checkout \$($get_branch_name))" \
		--bind="enter:+reload($git_branches_local)" \
		--bind="ctrl-m:execute(git merge \$($get_selected_branch))" \
		--bind="ctrl-r:execute(git rebase \$($get_selected_branch))" \
		--bind="ctrl-g:execute($git_show_subshell)" \
		--bind='ctrl-f:change-preview-label([ Diff ])' \
		--bind="ctrl-f:+change-preview($git_diff)" \
		--bind='ctrl-i:change-preview-label([ Commits ])' \
		--bind="ctrl-i:+change-preview($git_log)" \
		--bind='f1:toggle-header' \
		--bind='f2:toggle-preview' \
		--bind='ctrl-y:preview-up' \
		--bind='ctrl-e:preview-down' \
		--bind='ctrl-u:preview-half-page-up' \
		--bind='ctrl-d:preview-half-page-down'
}

fgb
