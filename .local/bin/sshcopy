#!/usr/bin/env bash

HOST=$(grep -P "^Host " ~/.ssh/config 2> /dev/null | awk '{print $2}' | grep -F -v "*" | fzf --height=40% --layout=reverse --border --prompt="Select Host > ")

if [ -z "$HOST" ]; then
  echo "No host selected."
  exit 1
fi

read -e -p "Remote Path: " REMOTE_PATH

if [ -z "$REMOTE_PATH" ]; then
  echo "No path provided."
  exit 1
fi

BASENAME=$(basename "$REMOTE_PATH")
if [ -e "$BASENAME" ]; then
  echo "Error: Destination '$BASENAME' already exists locally. Aborting to prevent overwrite."
  exit 1
fi

echo "Connecting to $HOST..."

if ssh "$HOST" "command -v rsync >/dev/null 2>&1"; then
  echo "Using rsync..."
  rsync -avzP "$HOST":"$REMOTE_PATH" .
else
  echo "rsync not found, falling back to scp..."
  scp -r "$HOST":"$REMOTE_PATH" .
fi
