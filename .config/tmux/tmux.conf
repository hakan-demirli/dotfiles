# remap prefix from 'C-b' to 'M-a'
set-option -g prefix M-a
bind-key M-a send-prefix
# unbind C-b
# set-option -g prefix2 Super-y
# bind-key Super-y send-prefix

# Set terminal options
set -g default-terminal "tmux-256color"
set -ag terminal-overrides ",xterm-256color:RGB"
set -sg terminal-overrides ",*:RGB"
set-option -g set-clipboard on

# set -g base-index 1 # Numberin should start from 1
set -g history-limit 50000
set -sg escape-time 0
setw -g mouse on

# kitty image preview support
set -g allow-passthrough on
set -ga update-environment TERM
set -ga update-environment TERM_PROGRAM


# Status Bar
set-option -g status-position top
set -g status-bg "#191a21"
set -g status-fg colour7
set -g status-justify left
set-option -g status-left ' '
set -g status-right-length 150

# Window Tabs
set -g window-status-separator " | "
set -g window-status-format "#W"
set -g window-status-current-format "#[fg=#50fa7b]#W"

# -- DRACULA THEME AND UI -----------------------------------------------------
set -g @dracula-bg '#282a36'
set -g @dracula-current-line '#44475a'
set -g @dracula-fg '#f8f8f2'
set -g @dracula-comment '#6272a4'
set -g @dracula-cyan '#8be9fd'
set -g @dracula-green '#50fa7b'
set -g @dracula-orange '#ffb86c'
set -g @dracula-pink '#ff79c6'
set -g @dracula-purple '#bd93f9'
set -g @dracula-red '#ff5555'
set -g @dracula-yellow '#f1fa8c'

# -- Status Bar
set -g status-position top
set -g status-style "bg=#{@dracula-bg},fg=#{@dracula-fg}"
set -g status-right "#[fg=#{@dracula-purple}] S: #{=10:session_name} #[fg=#{@dracula-pink}]#{?client_prefix, ● ,} "

# -- Window Tabs
setw -g window-status-separator ""
setw -g window-status-format "#[fg=#{@dracula-comment}] #I #W "
setw -g window-status-current-format "#[bg=#{@dracula-current-line},fg=#{@dracula-cyan},bold] #I #W "

# -- Panes
set -g pane-border-style "fg=#{@dracula-comment}"
set -g pane-active-border-style "fg=#{@dracula-purple}"


# -----------------------------------------------------------------------------
# -- Key Bindings
# -----------------------------------------------------------------------------

# -- Global (no-prefix) Bindings
bind -n M-b switch-client -l
bind -n M-g display-popup -w 80% -E "tmux_sessionizer.sh"
bind -n M-q confirm-before -p "Kill window? (y/n)" kill-window

# Harpoon-like switching
bind -n M-u run-shell "tmux_harpoon_switch.sh 1"
bind -n M-i run-shell "tmux_harpoon_switch.sh 2"
bind -n M-o run-shell "tmux_harpoon_switch.sh 3"
bind -n M-p run-shell "tmux_harpoon_switch.sh 4"

# bind -n M-z run-shell "tmux_create_split_todo.sh"

# bind -n Super-g run-shell "$HOME/.local/bin/tmux_harpoon_add.sh"
# bind -n Super-u run-shell "$HOME/.local/bin/tmux_harpoon_switch.sh 1"
# bind -n Super-i run-shell "$HOME/.local/bin/tmux_harpoon_switch.sh 2"
# bind -n Super-o run-shell "$HOME/.local/bin/tmux_harpoon_switch.sh 3"
# bind -n Super-p run-shell "$HOME/.local/bin/tmux_harpoon_switch.sh 4"

# -- Prefix Bindings
# Harpoon-like functionality
bind-key s run-shell "tmux_harpoon_add.sh"
bind-key M-s run-shell "tmux_harpoon_add.sh"
bind-key i run-shell "tmux_harpoon_edit.sh"
bind-key M-i run-shell "tmux_harpoon_edit.sh"
bind-key o run-shell "tmux_create_or_switch_window.sh"
bind-key M-o run-shell "tmux_create_or_switch_window.sh"

# Open history in editor
bind-key V run-shell "tmux_edit_tmux_history.sh"

# Pane navigation
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Copy previous command output
bind y run-shell "
tmux capture-pane -pS -2500 |
awk '
/❯/ { i++; idx[i] = NR }
{ lines[NR] = \$0 }
END {
  if (i >= 2) {
    # Determine range
    start = idx[i-1] + 1
    end = idx[i] - 1

    # Skip empty or whitespace-only lines from the bottom
    while (end >= start && lines[end] ~ /^[[:space:]]*$/)
      end--

    # Skip the first non-empty line above last ❯
    if (end >= start)
      end--

    # Print remaining lines
    for (j = start; j <= end; j++)
      print lines[j]
  }
}
' | wl-copy
"

# bind-key S display-popup -w 80% -E "tmux_session_fzf.sh"
# bind-key W display-popup -w 80% -E "tmux_window_fzf.sh"
# bind-key N display-popup -w 80% -E "tmux_new_session.sh"
# bind-key F display-popup -w 80% -E "tmux_sessionizer.sh"

# bind v split-window -h
# bind s split-window -v


set-window-option -g mode-keys vi
bind v copy-mode

# File Path Searching and Opening
bind-key c copy-mode \; send-keys -X search-forward \
  '(^|/|\<|[[:space:]"])((\.|\.\.)|[[:alnum:]~_"-]*)((/[][[:alnum:]_.#$%&+=@"-]+)+([/ "]|\.([][[:alnum:]_.#$%&+=@"-]+(:[0-9]+)?(:[0-9]+)?)|[][[:alnum:]_.#$%&+=@"-]+(:[0-9]+)(:[0-9]+)?)|(/[][[:alnum:]_.#$%&+=@"-]+){2,}([/ "]|\.([][[:alnum:]_.#$%&+=@"-]+(:[0-9]+)?(:[0-9]+)?)|[][[:alnum:]_.#$%&+=@"-]+(:[0-9]+)(:[0-9]+)?)?|(\.|\.\.)/([][[:alnum:]_.#$%&+=@"-]+(:[0-9]+)?(:[0-9]+)?))'

# Visual selection and copy
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel 'wl-copy'
bind-key -T copy-mode-vi o send-keys -X copy-pipe-and-cancel "tmux_harpoon_open_in_hx.sh '#{pane_current_path}'"

# Custom 'g' motion table in copy mode
bind -T copy-mode-vi g switch-client -T visg
bind -T visg h send -X start-of-line \; switch-client -T copy-mode-vi
bind -T visg s send -X start-of-line \; switch-client -T copy-mode-vi
bind -T visg l send -X end-of-line \; switch-client -T copy-mode-vi
bind -T visg g send -X top-line \; switch-client -T copy-mode-vi
bind -T visg e send -X bottom-line \; switch-client -T copy-mode-vi
